<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Textcat Telesto</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app">

    <!-- SERVER ICON BAR -->
    <div class="serverBar" id="serverBar">
        <button id="addServerBtn">+</button>
    </div>

    <!-- TOP BAR -->
    <div class="statusBar">
        <span id="currentServerName">No Server</span>

        <div class="userInfo" id="userInfo">
            <button id="userButton">No Server</button>
            <div class="sessionToken" id="sessionToken">—</div>
        </div>
    </div>

    <!-- CHANNEL LIST -->
    <div class="channelsBar">
        <ul id="channelList"></ul>
    </div>

    <!-- CHAT -->
    <div class="messageArea">
        <div id="messages"></div>
        <input id="messageInput" placeholder="Message..." />

        <button id="newMessagesBtn" class="new-messages hidden">
            New messages :)
        </button>

    </div>

    <!-- USERS -->
    <div class="usersBar" id="usersBar">
        <h4>Users</h4>
        <ul id="usersList"></ul>
    </div>

</div>

<!-- CONTEXT MENU -->
<!-- SERVER CONTEXT MENU -->
<div id="serverContextMenu" class="context-menu">
    <div id="reloadServer">Reload Connection</div>
    <div id="disconnectServer" style="color:red;">Disconnect</div>
    <div id="removeServer">Remove Server</div>

</div>

<!-- GLOBAL DIALOG -->
<div id="globalDialog" class="modal hidden dialog-overlay">
    <div class="modal-content dialog-box" id="dialogBox">
        <div class="dialog-header">
            <span id="dialogIcon" class="dialog-icon"></span>
            <h3 id="dialogTitle">Title</h3>
        </div>

        <p id="dialogMessage"></p>

        <button id="dialogCloseBtn">OK</button>
    </div>
</div>




<!-- ADD SERVER MODAL -->
<div id="addServerModal" class="modal hidden">
    <div class="modal-content">
        <h3>Add Server</h3>
        <input id="serverAddress" placeholder="localhost:8080">
        <input id="serverUsername" placeholder="Username">
        <input id="serverToken" placeholder="Session Token">
        <button id="connectServerBtn">Connect</button>
        <button id="registerServerBtn">Register</button>
        <button id="cancelServerBtn">Cancel</button>
    </div>
</div>

<script src="websocket.js"></script>
<script>
/* ======================
   CHAT FORMATTER (PARSER)
====================== */

function escapeHTMLChar(ch) {
    if (ch === "&") return "&amp;";
    if (ch === "<") return "&lt;";
    if (ch === ">") return "&gt;";
    return ch;
}

function formatChatMessage(input) {
    if (!input) return "";

    let i = 0;
    let out = "";

    function readUntilDollar() {
        let buf = "";
        while (i < input.length && input[i] !== "$") {
            buf += escapeHTMLChar(input[i]);
            i++;
        }
        return buf;
    }

    while (i < input.length) {
        const ch = input[i];

        /* ---------- COMMAND ---------- */
        if (ch === "$") {
            i++; // skip $

            // read command name
            let cmd = "";
            while (i < input.length && input[i] !== " " && input[i] !== "$") {
                cmd += input[i];
                i++;
            }

            /* ---------- NEWLINE ---------- */
            if (cmd === "n") {
                out += "<br>";
                if (input[i] === "$") i++;
                continue;
            }

            /* ---------- IMAGE ---------- */
            if (cmd.startsWith("img:")) {
                const url = escapeHTMLChar(cmd.slice(4));
                out += `<img src="${url}" style="max-width:300px;border-radius:6px;" />`;
                continue;
            }

            /* ---------- WEB LINK ---------- */
            if (cmd.startsWith("web:")) {
                const link = escapeHTMLChar(cmd.slice(4));
                out += `<a href="https://${link}" target="_blank" rel="noopener noreferrer">${link}</a>`;
                continue;
            }

            // skip space after command
            if (input[i] === " ") i++;

            // read content until closing $
            let content = "";
            while (i < input.length && input[i] !== "$") {
                content += escapeHTMLChar(input[i]);
                i++;
            }
            if (input[i] === "$") i++;

            /* ---------- HEADERS ---------- */
            if (cmd === "h1") out += `<h1>${content}</h1>`;
            else if (cmd === "h2") out += `<h2>${content}</h2>`;
            else if (cmd === "h3") out += `<h3>${content}</h3>`;
            else if (cmd === "h4") out += `<h4>${content}</h4>`;
            else {
                // unknown command → render literally
                out += `$${cmd} ${content}$`;
            }

            continue;
        }

        /* ---------- BOLD ---------- */
        if (ch === "*" && input[i + 1] === "*") {
            i += 2;
            let content = "";
            while (i < input.length && !(input[i] === "*" && input[i + 1] === "*")) {
                content += escapeHTMLChar(input[i]);
                i++;
            }
            i += 2;
            out += `<b>${content}</b>`;
            continue;
        }

        /* ---------- ITALIC ---------- */
        if (ch === "*") {
            i++;
            let content = "";
            while (i < input.length && input[i] !== "*") {
                content += escapeHTMLChar(input[i]);
                i++;
            }
            i++;
            out += `<i>${content}</i>`;
            continue;
        }

        /* ---------- NORMAL TEXT ---------- */
        out += escapeHTMLChar(ch);
        i++;
    }

    return out;
}
</script>




</body>
</html>
